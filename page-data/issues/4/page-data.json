{
    "componentChunkName": "component---src-templates-issues-tsx",
    "path": "/issues/4",
    "result": {"data":{"issuesJson":{"id":"36c6960e-278f-5ece-a3e3-b11334558d6a","title":"基于CNAME解析实践的域名优雅方案","number":4,"bodyHTML":"<p dir=\"auto\">通常，我们针对域名管理，以及其下 NGINX 配置文件的管理，大多都是分散的，这种分散并不是刻意为之，而是随着业务发展以及需求的对接，不知不觉中，发现域名加了一个又一个，配置文件更是各不相同，这对标准化而言是个灾难，对未来的操作更是注入了不稳定因素。</p>\n<p dir=\"auto\">所谓天下大势，分分合合。</p>\n<p dir=\"auto\">形如 hosts 到 dns，jenkinsfile 到 share library，我统一把这种思路归到初中时的一个数学思路：提取公因式。</p>\n<p dir=\"auto\">那么对于域名解析方面的实践，这里要介绍的，其实也是一次提取公因式。</p>\n<h2 dir=\"auto\">1，CNAME</h2>\n<h3 dir=\"auto\">1，分析</h3>\n<p dir=\"auto\">通过 CNAME 的方式，我们能够轻松的将一些相对集中的域名进行更加优雅统一的管理，这种方案的思路大概如下：</p>\n<p dir=\"auto\">假如我们的测试环境所有的域名有一个统一的入口 NGINX，此后所有的测试域名都在这里解析，如果按照传统的思路，那么一个域名对应一条 A 记录，那么如果测试环境有 100 个域名，就会需要添加 100 个 A 记录，这看起来似乎也没什么问题，但是，如果这个时候因为一些原因，此入口 NGINX 需要迁移，或者外网 IP 不得不更换，此时即便是有工具能够批量修改 100 个 A 记录，也是一个不够优雅便捷的方案。</p>\n<p dir=\"auto\">我们稍微调整一下方案：解析一个统一的 A 记录在入口处，然后其他域名都通过 CNAME 的方式解析到统一的 A 记录上，这样一来，就算是测试入口需要变更，也只需要更改一条记录即可解决此问题，而不需要考虑那 100 个了。</p>\n<h3 dir=\"auto\">2，示例</h3>\n<p dir=\"auto\">此时我拿个人域名 eryajf.net 举例，当前 wiki 站点域名解析如下：</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"$ dig wiki.eryajf.net\n\n; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; wiki.eryajf.net\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 15687\n;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 512\n;; QUESTION SECTION:\n;wiki.eryajf.net.\t\tIN\tA\n\n;; ANSWER SECTION:\nwiki.eryajf.net.\t599\tIN\tA\t8.136.215.57\n\n;; Query time: 253 msec\n;; SERVER: 8.8.8.8#53(8.8.8.8)\n;; WHEN: Tue Jun 22 23:24:33 CST 2021\n;; MSG SIZE  rcvd: 60\"><pre class=\"notranslate\">$ dig wiki.eryajf.net\n\n<span class=\"pl-k\">;</span> <span class=\"pl-s\"><span class=\"pl-k\">&lt;&lt;</span><span class=\"pl-k\">&gt;&gt;</span> DiG 9.10.6 &lt;&lt;&gt;&gt; wiki.eryajf.net</span>\n<span class=\"pl-s\">;; global options: +cmd</span>\n<span class=\"pl-s\">;; Got answer:</span>\n<span class=\"pl-s\">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 15687</span>\n<span class=\"pl-s\">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span>\n<span class=\"pl-s\"></span>\n<span class=\"pl-s\">;; OPT PSEUDOSECTION:</span>\n<span class=\"pl-s\">; EDNS: version: 0, flags:; udp: 512</span>\n<span class=\"pl-s\">;; QUESTION SECTION:</span>\n<span class=\"pl-s\">;wiki.eryajf.net.\t\tIN\tA</span>\n<span class=\"pl-s\"></span>\n<span class=\"pl-s\">;; ANSWER SECTION:</span>\n<span class=\"pl-s\">wiki.eryajf.net.\t599\tIN\tA\t8.136.215.57</span>\n<span class=\"pl-s\"></span>\n<span class=\"pl-s\">;; Query time: 253 msec</span>\n<span class=\"pl-s\">;; SERVER: 8.8.8.8#53(8.8.8.8)</span>\n<span class=\"pl-s\">;; WHEN: Tue Jun 22 23:24:33 CST 2021</span>\n<span class=\"pl-s\">;; MSG SIZE  rcvd: 60</span></pre></div>\n<p dir=\"auto\">可以看到是直接 A 记录解析到 <code class=\"notranslate\">8.136.215.57</code>。</p>\n<p dir=\"auto\">现在，我在 DNS 解析中做一些调整：</p>\n<ul dir=\"auto\">\n<li>\n<p dir=\"auto\">先加一条 A 记录 <code class=\"notranslate\">prod.eryajf.net</code>:</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://camo.githubusercontent.com/635b857234c57e6d7bc2b3d29e2197c694250a62efd0e0f357a3c173824cd171/68747470733a2f2f742e657279616a662e6e65742f696d67732f323032312f30392f626662633330373939313461313362382e6a7067\"><img src=\"https://camo.githubusercontent.com/635b857234c57e6d7bc2b3d29e2197c694250a62efd0e0f357a3c173824cd171/68747470733a2f2f742e657279616a662e6e65742f696d67732f323032312f30392f626662633330373939313461313362382e6a7067\" alt=\"image-20210622232855369\" data-canonical-src=\"https://t.eryajf.net/imgs/2021/09/bfbc3079914a13b8.jpg\" style=\"max-width: 100%;\"></a></p>\n</li>\n<li>\n<p dir=\"auto\">然后添加一条 CNAME 记录作为正常的服务域名 <code class=\"notranslate\">wiki.eryajf.net</code>:</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://camo.githubusercontent.com/cb220f997d93580184feb289d6b463e134af322da48717416a5671083b8a65a0/68747470733a2f2f742e657279616a662e6e65742f696d67732f323032312f30392f633636653433643138663333333433302e6a7067\"><img src=\"https://camo.githubusercontent.com/cb220f997d93580184feb289d6b463e134af322da48717416a5671083b8a65a0/68747470733a2f2f742e657279616a662e6e65742f696d67732f323032312f30392f633636653433643138663333333433302e6a7067\" alt=\"image-20210622233129677\" data-canonical-src=\"https://t.eryajf.net/imgs/2021/09/c66e43d18f333430.jpg\" style=\"max-width: 100%;\"></a></p>\n</li>\n</ul>\n<p dir=\"auto\">这个时候我们可以将域名 CNAME 到上边定义的 A 记录，那么就能把 100 个域名进行统一解析管理了。</p>\n<p dir=\"auto\"><code class=\"notranslate\">注意：</code>CNAME 记录值中域名最后位的点可带可不带。</p>\n<p dir=\"auto\">此时该域名的解析链路如下：</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"$ dig wiki.eryajf.net\n\n; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; wiki.eryajf.net\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 40403\n;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 512\n;; QUESTION SECTION:\n;wiki.eryajf.net.\t\tIN\tA\n\n;; ANSWER SECTION:\nwiki.eryajf.net.\t599\tIN\tCNAME\tprod.eryajf.net.\nprod.eryajf.net.\t599\tIN\tA\t8.136.215.57\n\n;; Query time: 440 msec\n;; SERVER: 8.8.8.8#53(8.8.8.8)\n;; WHEN: Tue Jun 22 23:33:39 CST 2021\n;; MSG SIZE  rcvd: 79\"><pre class=\"notranslate\"><code class=\"notranslate\">$ dig wiki.eryajf.net\n\n; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; wiki.eryajf.net\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 40403\n;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 512\n;; QUESTION SECTION:\n;wiki.eryajf.net.\t\tIN\tA\n\n;; ANSWER SECTION:\nwiki.eryajf.net.\t599\tIN\tCNAME\tprod.eryajf.net.\nprod.eryajf.net.\t599\tIN\tA\t8.136.215.57\n\n;; Query time: 440 msec\n;; SERVER: 8.8.8.8#53(8.8.8.8)\n;; WHEN: Tue Jun 22 23:33:39 CST 2021\n;; MSG SIZE  rcvd: 79\n</code></pre></div>\n<p dir=\"auto\">其中的 <code class=\"notranslate\">ANSWER SECTION</code>很清晰地列出了整个链路解析流程。</p>","updatedAt":"2025-05-18T08:27:45Z","upvoteCount":1,"author":{"login":"eryajf","avatarUrl":"https://avatars.githubusercontent.com/u/33259379?u=e4a4090a38ac2473aaed4ef9945233636776c6c3&v=4","url":"https://github.com/eryajf"},"category":{"isAnswerable":false,"name":"最佳实践","emoji":":partying_face:"},"labels":{"edges":[{"node":{"name":"最佳实践","color":"0E8A16"}}]},"comments":{"edges":[]}}},"pageContext":{"number":4,"previous":{"title":"rgd.yml","number":1},"next":{"title":"第二期：MCP与K8S结合的实践心得-2025年4月11日晚上九点","number":3}}},
    "staticQueryHashes": ["151096407","2861350382"]}